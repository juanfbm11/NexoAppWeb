@page "/user/usuarioback"
@using NexoAPP.Models
@using NexoAPP.Services
@inject UsuarioService usuarioService
@inject IJSRuntime JSRuntime
@inherits LayoutComponentBase

<link rel="stylesheet" href="/css/usuarioBack.css" />

<div class="panel-container">

    <div class="header-section">
        <h1>👤 Usuarios Registrados</h1>

        <button class="btn-primary-dark" data-bs-toggle="modal" data-bs-target="#usuarioModal"
                @onclick="NuevoUsuarioModal">
            <i class="bi bi-patch-plus-fill"></i> Nuevo Usuario
        </button>
    </div>

    <div class="table-wrapper">
        <table class="table-custom">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Teléfono</th>
                    <th>Dirección</th>
                    <th>Correo</th>
                    <th>Contraseña</th>
                    <th>Nacimiento</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                @if (usuarios?.Count > 0)
                {
                    @foreach (var usuario in usuarios)
                    {
                        <tr>
                            <td>@usuario.IdUsuario</td>
                            <td>@usuario.Nombre</td>
                            <td>@usuario.Telefono</td>
                            <td>@usuario.Direccion</td>
                            <td>@usuario.Correo</td>
                            <td class="blur-text">@usuario.Contrasena</td>
                            <td>@usuario.FechaNacimiento.ToShortDateString()</td>
                            <td>
                                <button class="btn-warning-dark" data-bs-toggle="modal" data-bs-target="#usuarioModal"
                                        @onclick="() => EditarUsuario(usuario)">
                                    ✏️
                                </button>

                                <button class="btn-danger-dark" @onclick="() => EliminarUsuario(usuario)">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="no-rows">No hay usuarios registrados.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>

<!-- MODAL -->
<div class="modal fade" id="usuarioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-dark">

            <div class="modal-header modal-header-dark">
                <h5 class="modal-title">@tituloModal</h5>
                <button type="button" class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <div class="form-group-dark">
                    <label>Nombre Completo</label>
                    <input class="input-dark" @bind="usuarioActual.Nombre" />
                </div>

                <div class="form-group-dark">
                    <label>Correo</label>
                    <input class="input-dark" @bind="usuarioActual.Correo" type="email" />
                </div>

                <div class="form-group-dark">
                    <label>Contraseña</label>
                    <input class="input-dark" @bind="usuarioActual.Contrasena" type="password" />
                </div>

                <div class="form-group-dark">
                    <label>Teléfono</label>
                    <input class="input-dark" @bind="usuarioActual.Telefono" />
                </div>

                <div class="form-group-dark">
                    <label>Dirección</label>
                    <input class="input-dark" @bind="usuarioActual.Direccion" />
                </div>

                <div class="form-group-dark">
                    <label>Fecha de nacimiento</label>
                    <input class="input-dark" type="date" @bind="usuarioActual.FechaNacimiento" />
                </div>

            </div>

            <div class="modal-footer modal-footer-dark">
                <button class="btn-secondary-dark" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn-primary-dark" @onclick="GuardarUsuario">Guardar</button>
            </div>

        </div>
    </div>
</div>

@code {
    private List<Usuario> usuarios = new();
    private Usuario usuarioActual = new();
    private string tituloModal = "Nuevo Usuario";
    private bool esEdicion = false;

    protected override async Task OnInitializedAsync()
    {
        usuarios = await usuarioService.GetAllAsync();
    }

    private void NuevoUsuarioModal()
    {
        usuarioActual = new Usuario();
        tituloModal = "Nuevo Usuario";
        esEdicion = false;
    }

    private void EditarUsuario(Usuario usuario)
    {
        usuarioActual = new Usuario
        {
            IdUsuario = usuario.IdUsuario,
            Nombre = usuario.Nombre,
            Telefono = usuario.Telefono,
            Direccion = usuario.Direccion,
            Correo = usuario.Correo,
            Contrasena = usuario.Contrasena,
            FechaNacimiento = usuario.FechaNacimiento
        };

        tituloModal = "Editar Usuario";
        esEdicion = true;
    }

    private async Task GuardarUsuario()
    {
        if (esEdicion)
            await usuarioService.UpdateAsync(usuarioActual);
        else
            await usuarioService.CreateAsync(usuarioActual);

        usuarios = await usuarioService.GetAllAsync();
    }

    private async Task EliminarUsuario(Usuario usuario)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm",
            $"¿Eliminar al usuario {usuario.Nombre}?"))
        {
            await usuarioService.DeleteAsync(usuario.IdUsuario);
            usuarios = await usuarioService.GetAllAsync();
        }
    }
}