@page "/admin/productos"
@using NexoAPP.Models
@using NexoAPP.Services
@using Microsoft.AspNetCore.Components.Forms
@inject ProductoService ProductoService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<link href="css/Productoback.css" rel="stylesheet" />

<div class="productos-panel">

    <div class="panel-header">
        <div>
            <h2 class="titulo">🛒 Gestión de Productos</h2>
            <p class="subtitulo">Administra, edita o crea nuevos productos para la tienda.</p>
        </div>

        <button class="btn-primary-dark" @onclick="MostrarModalNuevo">
            <i class="bi bi-plus-circle"></i> Nuevo Producto
        </button>
    </div>

    <div class="tabla-container">
        <table class="tabla-dark">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Categoría</th>
                    <th>Cantidad</th>
                    <th>Imagen</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                @if (productos is null)
                {
                    <tr><td colspan="7" class="tabla-vacia">Cargando Productos...</td></tr>
                }
                else if (!productos.Any())
                {
                    <tr><td colspan="7" class="tabla-vacia">No hay productos registrados.</td></tr>
                }
                else
                {
                    @foreach (var producto in productos)
                    {
                        <tr>
                            <td>@producto.IdProducto</td>
                            <td>@producto.Nombre</td>
                            <td>@producto.Precio.ToString("C0")</td>
                            <td>@producto.IdCategoria</td>
                            <td>@producto.Cantidad</td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(producto.Imagen))
                                {
                                    <img src="@producto.Imagen" class="img-mini" />
                                }
                            </td>
                            <td>
                                <button class="btn-warning-dark" @onclick="() => EditarProducto(producto.IdProducto)">
                                    ✏️ Editar
                                </button>

                                <button class="btn-danger-dark" @onclick="() => EliminarProducto(producto.IdProducto)">
                                    🗑️ Eliminar
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- MODAL OSCURO -->
    @if (mostrarModal)
    {
        <div class="modal-backdrop-dark">

            <div class="modal-dark">
                <h3 class="modal-title-dark">@tituloModal</h3>

                <EditForm Model="@productoSeleccionado">
                    <DataAnnotationsValidator />

                    <div class="form-grid">

                        <div class="form-group-dark">
                            <label>Nombre</label>
                            <InputText class="input-dark" @bind-Value="productoSeleccionado.Nombre" />
                        </div>

                        <div class="form-group-dark">
                            <label>Descripción</label>
                            <InputTextArea class="input-dark" rows="3"
                                           @bind-Value="productoSeleccionado.Descripcion" />
                        </div>

                        <div class="form-group-dark">
                            <label>Precio</label>
                            <InputNumber class="input-dark" @bind-Value="productoSeleccionado.Precio" />
                        </div>

                        <div class="form-group-dark">
                            <label>Cantidad</label>
                            <InputNumber class="input-dark" @bind-Value="productoSeleccionado.Cantidad" />
                        </div>

                        <div class="form-group-dark">
                            <label>Categoría</label>
                            <InputSelect class="input-dark" @bind-Value="productoSeleccionado.IdCategoria">
                                <option value="">Selecciona una categoría</option>
                                <option value="1">Ropa</option>
                                <option value="2">Calzado</option>
                                <option value="3">Accesorios</option>
                                <option value="4">Tecnología</option>
                                <option value="5">Hogar</option>
                                <option value="6">Belleza</option>
                                <option value="7">Deportes</option>
                                <option value="8">Juguetes</option>
                                <option value="9">Mascotas</option>
                                <option value="10">Otros</option>
                            </InputSelect>
                        </div>

                        <div class="form-group-dark">
                            <label>Imagen (URL)</label>
                            <InputText class="input-dark" @bind-Value="productoSeleccionado.Imagen" />
                        </div>

                        @if (!string.IsNullOrWhiteSpace(productoSeleccionado.Imagen))
                        {
                            <div class="preview-container">
                                <img src="@productoSeleccionado.Imagen" class="img-preview" />
                            </div>
                        }

                    </div>

                    <div class="modal-footer-dark">
                        <button class="btn-secondary-dark" type="button"
                                @onclick="CerrarModal">
                            Cancelar
                        </button>

                        <button class="btn-primary-dark" type="button"
                                @onclick="GuardarProducto">
                            💾 Guardar
                        </button>
                    </div>

                </EditForm>

            </div>

        </div>
    }

</div>

@code {

    private List<Producto>? productos;
    private Producto productoSeleccionado = new();
    private bool mostrarModal = false;
    private string tituloModal = "Nuevo Producto";

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }

    private async Task CargarProductos()
    {
        productos = await ProductoService.GetAllAsync();
    }

    private void MostrarModalNuevo()
    {
        productoSeleccionado = new Producto();
        tituloModal = "Nuevo Producto";
        mostrarModal = true;
    }

    private void EditarProducto(int id)
    {
        var producto = productos?.FirstOrDefault(p => p.IdProducto == id);

        if (producto != null)
        {
            productoSeleccionado = new Producto
            {
                IdProducto = producto.IdProducto,
                Nombre = producto.Nombre,
                Descripcion = producto.Descripcion,
                Precio = producto.Precio,
                Cantidad = producto.Cantidad,
                IdCategoria = producto.IdCategoria,
                Imagen = producto.Imagen
            };

            tituloModal = "Editar Producto";
            mostrarModal = true;
        }
    }

    private async Task GuardarProducto()
    {
        try
        {
            if (productoSeleccionado.IdProducto == 0)
            {
                await ProductoService.CrearProductoAsync(productoSeleccionado);
            }
            else
            {
                await ProductoService.ActualizarProductoAsync(
                    productoSeleccionado.IdProducto,
                    productoSeleccionado
                );
            }

            mostrarModal = false;
            await CargarProductos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al guardar: {ex.Message}");
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
    }

    private async Task EliminarProducto(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm", "¿Seguro que deseas eliminar este producto?");

        if (!confirmar)
            return;

        await ProductoService.EliminarProductoAsync(id);
        await CargarProductos();
    }
}