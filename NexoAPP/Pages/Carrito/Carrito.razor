@page "/Carrito"
@using System.Linq
@using NexoAPP.Models
@inject NavigationManager nav
@inject CarritoService CarritoService 


<link href="css/Carrito.css" rel="stylesheet" />

<div class="cart-container">
    <h2>🛒 Carrito de Compras</h2>

    @if (productos.Count == 0)
    {
        <div class="cart-empty">
            <p>Tu carrito está vacío 😔</p>
            <a href="/" class="btn btn-warning">Seguir Comprando</a>
        </div>
    }
    else
    {
        <div class="cart-items">
            @foreach (var producto in productos)
            {
                <div class="cart-item">
                    <img src="@producto.Imagen" alt="@producto.Nombre" />
                    <div class="item-info">
                        <h5>@producto.Nombre</h5>
                        <p class="price">$@producto.Precio</p>

                        <div class="item-actions">
                            <button class="btn quantity" @onclick="@(() => DisminuirCantidad(producto))">-</button>
                            <span>@producto.Cantidad</span>
                            <button class="btn quantity" @onclick="@(() => AumentarCantidad(producto))">+</button>

                            <button class="btn remove" @onclick="@(() => EliminarProducto(producto))">🗑️</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="cart-summary">
            <h4>Total: <span>$@Total</span></h4>

            <button class="btn checkout" @onclick="IrAPago">
                Finalizar Compra
            </button>
        </div>
    }
</div>

@code {
    private List<Producto> productos = new();

    protected override async Task OnInitializedAsync()

    {
        productos = await CarritoService.ObtenerProductosAsync();
        CarritoService.OnChange += StateHasChanged;
        
    }     

    decimal Total => productos.Sum(p => p.Precio * p.Cantidad);

    void AumentarCantidad(Producto p)
    {
        p.Cantidad++;
        CarritoService.AgregarProducto(p);
    }

    void DisminuirCantidad(Producto p)
    {
        if (p.Cantidad > 1)
        {
            p.Cantidad--;
            CarritoService.AgregarProducto(p);
        }
    }

    void EliminarProducto(Producto p)
    {
        CarritoService.EliminarProducto(p.IdProducto);
    }

    void IrAPago() => nav.NavigateTo("/Pago");
}